# 데이터 다운로드 기능

## 개요
실적, 부적합, 고객 불만 데이터를 월별로 CSV 파일로 다운로드할 수 있는 기능입니다.

## 주요 기능

### 1. 사이드바 메뉴 추가
- 메뉴명: "데이터 다운로드"
- 위치: KPI 목표 관리와 포스트잇 보드 사이
- 권한: 모든 사용자 (Guest 이상)
- 아이콘: 다운로드 아이콘

### 2. 페이지 구조
- **탭 네비게이션**: 3개의 탭으로 구성
  - 실적 다운로드
  - 부적합 내역 다운로드
  - 고객 불만 내역 다운로드

- **연도별 그룹화 목록** (2025년 10월 기준 업데이트)
  - 최근 5개년(60개월) 데이터 표시
  - 연도별로 그룹화하여 표시 (예: 2025년, 2024년, 2023년, 2022년, 2021년)
  - 각 연도 내에서 12개월을 그리드 형태로 표시 (12월부터 1월 순)
  - 현재 연도의 미래 달도 표시 (비활성화 상태)
  - 월 버튼 클릭으로 직접 다운로드
  - 형식: 
    - 연도 헤더: "YYYY년" (그라데이션 배경)
    - 월 버튼: "MM월" + 다운로드 아이콘

### 3. 다운로드 기능
- **파일 형식**: CSV (UTF-8 BOM 포함)
- **파일명 규칙**:
  - 실적: `performance_YYYY_MM.csv`
  - 부적합: `nonconformance_YYYY_MM.csv`
  - 고객불만: `customer_complaints_YYYY_MM.csv`

- **CSV 헤더 (실적)**:
  - 실적 ID, 유형, 실적일, 업체명, 품명, 관리번호, 수량, 생산처, 요일, 등록자, 등록일시

- **CSV 헤더 (부적합)**:
  - NCR NO, 유형, 발생일, 업체명, 품명, 관리번호, 부적합 수량, 단가, 가중치, 합계금액, 불량 유형, 발생 원인, 6M 카테고리, 발견공정, 공정/부서, 작업자, 근본원인, 비고, 등록자, 등록일시

- **CSV 헤더 (고객불만)**:
  - CCR NO, 발생일, 업체명, 품명, 수량, 단가, 합계금액, 불량 유형, 발생 원인, 6M 카테고리, 불만 내용, 조치 내용, 조치 여부, 등록자, 등록일시

### 4. 사용자 피드백
- **Toast 알림 (Sonner)**:
  - 다운로드 성공 시: "YYYY년 M월 데이터가 다운로드되었습니다."
  - 다운로드 실패 시: 에러 메시지 표시

- **알림 모달**:
  - 해당 월에 데이터가 없을 경우 표시
  - 디자인: 기존 삭제/복구 모달과 통일
  - 아이콘: 노란색 정보 아이콘
  - 메시지: "YYYY년 M월에 입력된 데이터가 없습니다."

### 5. 로딩 상태
- 월 버튼에 로딩 상태 표시
- 스피너 아이콘 애니메이션

### 6. UI/UX 개선사항
- **컴팩트한 디자인**: 리스트 방식에서 그리드 방식으로 변경하여 공간 효율성 증대
- **연도별 그룹화**: 연한 파란색 그라데이션 헤더로 명확한 구분 (from-blue-100 to-indigo-100)
- **미래 달 표시**: 현재 연도의 아직 오지 않은 달도 회색으로 표시 (비활성화)
- **자동 갱신**: 1시간마다 현재 월을 체크하여 미래 달이 자동으로 활성화
- **반응형 그리드**: 화면 크기에 따라 2~6열로 자동 조정
- **호버 효과**: 마우스 오버 시 시각적 피드백 제공
- **개선된 아이콘**: 다운로드 아이콘 크기를 16px로 증가, stroke-width 2.5로 더욱 선명하게 표시

## 백엔드 API

### 1. 실적 CSV 다운로드
- **URL**: `GET /api/performance/export/`
- **Query Parameters**:
  - `year`: 연도 (예: 2025)
  - `month`: 월 (1~12)
- **권한**: IsAuthenticated
- **감사 로그**: EXPORT_PERFORMANCE

### 2. 부적합 CSV 다운로드
- **URL**: `GET /api/nonconformance/export/`
- **Query Parameters**:
  - `year`: 연도 (예: 2025)
  - `month`: 월 (1~12)
- **권한**: IsAuthenticated
- **감사 로그**: EXPORT_NONCONFORMANCE

### 3. 고객불만 CSV 다운로드
- **URL**: `GET /api/customer-complaints/export/`
- **Query Parameters**:
  - `year`: 연도 (예: 2025)
  - `month`: 월 (1~12)
- **권한**: IsAuthenticated
- **감사 로그**: EXPORT_CUSTOMER_COMPLAINT

## 에러 처리

### 백엔드
- 400: 잘못된 파라미터 (년도/월 누락 또는 잘못된 형식)
- 404: 해당 연월에 데이터 없음
- 500: 서버 오류

### 프론트엔드
- 404 에러 시: 알림 모달 표시
- 기타 에러: Toast 알림으로 에러 메시지 표시
- Blob 응답 에러 처리: FileReader로 JSON 파싱

## 보안 고려사항
- 모든 API는 인증 필요 (IsAuthenticated)
- 사용자는 자신이 접근 가능한 데이터만 다운로드 가능
- 감사 로그에 다운로드 이력 기록

## 사용 예시

1. 사용자가 사이드바에서 "데이터 다운로드" 메뉴 클릭
2. "실적 다운로드" 탭 선택 (기본)
3. 최근 5개년의 연도별 그룹을 확인
4. 원하는 연도의 월 버튼 클릭 (미래 달은 비활성화)
5. 데이터가 있는 경우: CSV 파일 다운로드 + 성공 Toast
6. 데이터가 없는 경우: 알림 모달 표시

## 파일 구조

### 백엔드
- `backend/performance/views.py`: `performance_csv_export()` 함수 추가
- `backend/performance/urls.py`: export 엔드포인트 추가
- `backend/nonconformance/views.py`: `nonconformance_csv_export()` 함수 추가
- `backend/nonconformance/urls.py`: export 엔드포인트 추가
- `backend/customer_complaints/views.py`: `customer_complaint_csv_export()` 함수 추가
- `backend/customer_complaints/urls.py`: export 엔드포인트 추가

### 프론트엔드
- `frontend/app/data-download/page.tsx`: 데이터 다운로드 페이지
- `frontend/lib/api.ts`: exportCSV 함수 추가 (3개 API)
- `frontend/components/ui/Sidebar.tsx`: 메뉴 아이템 추가

## 기술 스택
- **백엔드**: Django REST Framework, Python csv 모듈
- **프론트엔드**: Next.js 14, React, TypeScript, Sonner (Toast)
- **파일 다운로드**: Blob API, URL.createObjectURL

## 테스트 체크리스트
- [ ] 각 탭에서 데이터 다운로드 성공
- [ ] 데이터가 없는 월 선택 시 알림 모달 표시
- [ ] CSV 파일이 올바른 형식으로 다운로드
- [ ] Excel에서 한글이 깨지지 않음 (UTF-8 BOM)
- [ ] 다운로드 중 로딩 상태 표시
- [ ] Toast 알림이 올바르게 표시
- [ ] 감사 로그에 다운로드 이력 기록
- [ ] 권한 체크 (로그인 필요)
- [ ] 최근 5개년 데이터가 올바르게 표시
- [ ] 연도별 그룹화가 정상 작동
- [ ] 현재 연도의 미래 달이 비활성화 상태로 표시
- [ ] 반응형 그리드 레이아웃이 다양한 화면 크기에서 정상 작동

