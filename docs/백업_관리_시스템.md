# 백업 관리 및 데이터 아카이빙 시스템

## 개요

데이터베이스 백업 자동화 및 오래된 데이터 자동 삭제 시스템입니다.

## 주요 기능

### 1. 자동 백업 스케줄
- **실행 시간**: 매주 일요일 자정 (월요일로 넘어가는 시점)
- **백업 위치**: `backend/backups/` 디렉토리
- **파일명 형식**: `db_backup_YYYYMMDD_HHMMSS.sqlite3`
- **자동 정리**: 최신 10개 백업 파일만 유지, 오래된 파일 자동 삭제

### 2. 자동 데이터 아카이빙 (삭제)
- **실행 시간**: 매년 1월 1일 자정
- **삭제 대상**:
  - 실적(PerformanceRecord): 7년 이상 된 데이터 삭제
  - 부적합(Nonconformance): 7년 이상 된 데이터 삭제
  - 고객불만(CustomerComplaint): 7년 이상 된 데이터 삭제
  - 감사로그(AuditLog): 1년 이상 된 데이터 삭제
- **보존 정책**:
  - 최근 5년 데이터: 완전 보존
  - 6년전 데이터: DB에 존재하지만 조회 시 제외 (필요 시 DB에서 직접 확인 가능)
  - 7년전 데이터: 완전 삭제

### 3. 수동 백업 및 복원
- **권한**: 실무자 이상 (role_level >= 1)
- **기능**:
  - 백업 파일 생성 및 다운로드
  - 백업 파일 업로드 및 복원
  - 백업 이력 조회
  - 삭제 가능한 데이터 통계 확인

## 사용 방법

### 백업 관리 페이지 접근
1. QMS에 로그인 (실무자 또는 관리자 권한 필요)
2. 사이드바에서 "백업 관리" 메뉴 클릭
3. `/backup` 페이지로 이동

### 수동 백업 다운로드
1. "백업 다운로드" 섹션에서 "백업 파일 생성 및 다운로드" 버튼 클릭
2. 백업 파일이 생성되고 자동으로 다운로드됨
3. 파일명: `db_backup_YYYYMMDD_HHMMSS.sqlite3`

### 백업 복원
1. "백업 복원" 섹션에서 파일 선택 영역 클릭
2. `.sqlite3` 파일 선택 (최대 1GB)
3. 경고 확인 후 "확인 - 복원 진행" 버튼 클릭
4. ⚠️ **주의**: 복원 시 현재 데이터베이스의 모든 데이터가 대체됩니다!

### 백업 이력 확인
- 페이지 하단 "백업 이력" 테이블에서 확인
- 표시 정보: 백업 일시, 유형(자동/수동), 파일 크기, 생성자, 비고

### 삭제 예정 데이터 확인
- "자동 삭제 대상 데이터 통계" 카드에서 확인
- 실적, 부적합, 고객불만, 감사로그 별로 삭제 예정 건수 표시

## 기술 상세

### 백엔드 구조

#### 모델 (BackupRecord)
```python
- backup_date: 백업 일시
- file_size: 파일 크기 (바이트)
- backup_type: 백업 유형 (auto/manual)
- file_path: 파일 경로
- created_by: 생성자 (자동 백업은 null)
- note: 비고
```

#### API 엔드포인트
- `POST /api/backup/download/` - 백업 파일 생성 및 다운로드
- `POST /api/backup/upload/` - 백업 파일 업로드 및 복원
- `GET /api/backup/history/` - 백업 이력 조회
- `GET /api/backup/archivable-stats/` - 삭제 가능한 데이터 통계

#### 스케줄러 (Django APScheduler)
- **주간 백업**: Cron `0 0 * * 0` (일요일 자정)
- **연간 아카이빙**: Cron `0 0 1 1 *` (1월 1일 자정)
- 타임존: `Asia/Seoul` (한국 시간)

#### 감사 로그 액션
- `DOWNLOAD_BACKUP`: 백업 다운로드
- `UPLOAD_BACKUP`: 백업 업로드
- `AUTO_BACKUP`: 자동 백업 생성
- `DELETE_OLD_DATA`: 오래된 데이터 삭제

### 프론트엔드

#### 페이지 경로
- `/backup` - 백업 관리 페이지

#### 권한 체크
```typescript
if (user.role_level < 1) {
  // 접근 거부
}
```

#### UI 컴포넌트
- shadcn/ui 기반 (Card, Button, Table, Alert 등)
- lucide-react 아이콘
- sonner 토스트 알림

## 보안 고려사항

### ⚠️ 경고
1. **백업 파일 검증**: 업로드 시 SQLite 파일 형식 검증
2. **파일 크기 제한**: 최대 1GB (DDoS 방지)
3. **권한 제한**: 실무자 이상만 접근 가능
4. **파일 저장 위치**: 웹 접근 불가 영역 (`backend/backups/`)
5. **복원 작업**: 현재 DB를 임시 백업 후 복원 (실패 시 롤백)

### 파일 검증 로직
```python
def validate_backup_file(file_path):
    # 1. 파일 존재 확인
    # 2. .sqlite3 확장자 확인
    # 3. 파일 크기 확인 (최대 1GB)
    # 4. SQLite 파일 시그니처 확인 (b'SQLite format 3')
```

## 운영 가이드

### 서버 시작 시
- 스케줄러가 자동으로 시작됨 (`BackupManagementConfig.ready()`)
- 스케줄된 작업이 등록됨

### 스케줄러 확인
```bash
# Django 쉘에서 확인
uv run python backend/manage.py shell

from django_apscheduler.models import DjangoJob
jobs = DjangoJob.objects.all()
for job in jobs:
    print(f"{job.name}: {job.next_run_time}")
```

### 수동 아카이빙 실행 (테스트/긴급 시)
```python
from backup_management.data_archiver import archive_old_data

# Django 쉘에서 실행
stats = archive_old_data()
print(stats)
```

### 백업 파일 수동 생성 (명령줄)
```python
from backup_management.backup_utils import create_backup

# Django 쉘에서 실행
backup_path, file_size = create_backup(backup_type='manual', created_by=None)
print(f"백업 생성: {backup_path} ({file_size} bytes)")
```

## 디렉토리 구조

```
backend/
├── backup_management/          # 백업 관리 앱
│   ├── models.py              # BackupRecord 모델
│   ├── views.py               # API 뷰
│   ├── serializers.py         # 시리얼라이저
│   ├── backup_utils.py        # 백업 유틸리티
│   ├── data_archiver.py       # 데이터 아카이빙
│   ├── scheduler.py           # APScheduler 설정
│   └── urls.py                # URL 라우팅
├── backups/                    # 백업 파일 저장 위치
│   └── db_backup_*.sqlite3    # 백업 파일들
└── db.sqlite3                 # 운영 데이터베이스

frontend/
└── app/
    └── backup/
        └── page.tsx           # 백업 관리 페이지
```

## 로그 확인

### 스케줄러 로그
```bash
# backend/logs/ 디렉토리 확인
tail -f backend/logs/django.log
```

### 감사 로그 확인
- QMS 웹 인터페이스 > 감사 로그 페이지
- 필터: `AUTO_BACKUP`, `DELETE_OLD_DATA`, `DOWNLOAD_BACKUP`, `UPLOAD_BACKUP`

## 트러블슈팅

### 스케줄러가 실행되지 않음
1. 서버 재시작
2. 마이그레이션 확인: `uv run python backend/manage.py migrate`
3. 스케줄러 테이블 확인: `django_apscheduler_djangojob`

### 백업 파일이 생성되지 않음
1. `backend/backups/` 디렉토리 권한 확인
2. 디스크 공간 확인
3. 로그 확인

### 복원 실패
1. 백업 파일이 손상되지 않았는지 확인
2. 파일 크기 및 형식 확인
3. 로그에서 오류 메시지 확인

## 업데이트 내역

- **2025-10-18**: 초기 구현 완료
  - 자동 백업 스케줄러 (매주 일요일 자정)
  - 자동 데이터 아카이빙 (매년 1월 1일 자정)
  - 수동 백업/복원 페이지
  - 감사 로그 통합

