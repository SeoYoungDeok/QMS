# 부적합 등록 및 관리 페이지 기능 명세서 — 개정 통합본 (inhouse / incoming 구분, 영문 컬럼 반영)

본 문서는 부적합(Nonconformance) 등록·관리 페이지의 **최신 기준**을 통합 정리한 것입니다.  
개정사항: **사내(inhouse) / 수입(incoming) 부적합 구분 필드 추가**, 데이터 모델의 **한글 컬럼명을 영문 컬럼명으로 정규화**.

---

## 1) 페이지 개요
- **페이지명:** 부적합 등록 및 관리 (Nonconformance Management)
- **목적:**
  - 발생한 부적합 내역 등록·조회·수정·삭제
  - 불량 유형(`defect_types`)과 발생 원인(`defect_causes`)을 **6M 분류**로 체계적 관리
  - **사내(inhouse) / 수입(incoming)** 부적합을 명확히 구분 및 분석
- **접근 권한(권장):**
  - 게스트(0): 읽기 전용
  - 실무자(1): 등록·수정·삭제 가능
  - 관리자(2): 전체 관리 + 감사 로그 열람
- **감사 로그:** `CREATE_NONCONFORMANCE`, `UPDATE_NONCONFORMANCE`, `DELETE_NONCONFORMANCE` (write-once)

---

## 2) 데이터 모델 (영문 컬럼, 최신)

### 2.1 `nonconformances` — 부적합 본문
| Column           | Type                       | Description                                    |
| ---------------- | -------------------------- | ---------------------------------------------- |
| id               | BIGINT PK AI               | Internal PK                                    |
| ncr_uid          | CHAR(26) UNIQUE            | ULID business key                              |
| **type**         | ENUM('inhouse','incoming') | 부적합 유형(사내/수입)                                  |
| occurrence_date  | DATE                       | 발생일 (기존: 발생일)                                  |
| ncr_no           | VARCHAR(50)                | 부적합 발행 번호 (기존: NCR NO)                         |
| vendor           | VARCHAR(100)               | 업체명                                            |
| product_name     | VARCHAR(100)               | 품명                                             |
| control_no       | VARCHAR(100)               | 관리번호                                           |
| defect_qty       | INT                        | 부적합 수량                                         |
| unit_price       | DECIMAL(18,2)              | 단가(금액)                                         |
| weight_factor    | DECIMAL(4,3)               | 가중치 0~1.000                                    |
| total_amount     | DECIMAL(18,2)              | 합계 = defect_qty × unit_price × weight_factor   |
| detection_stage  | VARCHAR(30)                | 발견공정: shipping/process/incoming (자유입력 또는 ENUM) |
| defect_type_code | VARCHAR(20)                | 불량유형 코드(참조: `defect_types.code`)               |
| cause_code       | VARCHAR(20)                | 발생원인 코드(참조: `defect_causes.code`)              |
| why1             | VARCHAR(255) NULL          | 5Why (1)                                       |
| why2             | VARCHAR(255) NULL          | 5Why (2)                                       |
| why3             | VARCHAR(255) NULL          | 5Why (3)                                       |
| why4             | VARCHAR(255) NULL          | 5Why (4)                                       |
| why5             | VARCHAR(255) NULL          | 5Why (5)                                       |
| root_cause       | VARCHAR(255) NULL          | 최종불량원인                                         |
| operators        | JSON NULL                  | 작업자 배열(사용자 id 또는 이름 문자열 배열)                    |
| process_name     | VARCHAR(100) NULL          | 공정/부서 (MCT, CNC, 출하)                           |
| weekday_code     | CHAR(3) NULL               | MON..SUN (occurrence_date로 서버 계산)              |
| note             | TEXT NULL                  | 비고                                             |
| created_by       | BIGINT FK→users.id         | 작성자                                            |
| created_at       | DATETIME                   | 생성                                             |
| updated_at       | DATETIME                   | 수정                                             |

**유효성/규칙**
- `type` **필수** (`inhouse` / `incoming`)
- `defect_qty ≥ 1`, `unit_price ≥ 0`, `weight_factor ∈ [0,1]`
- `total_amount`는 서버에서 계산·저장(신뢰 확보)
- `weekday_code`는 서버가 `occurrence_date`로 계산 (`MON..SUN`)
- `defect_type_code`·`cause_code`는 **코드 테이블 값만 허용**

**인덱스 권장**
- `idx_nc_date` (`occurrence_date`)
- `idx_nc_type_date` (`type`,`occurrence_date`)
- `idx_nc_vendor` (`vendor`)
- `idx_nc_control_no` (`control_no`)
- `idx_nc_defect_type` (`defect_type_code`)
- `idx_nc_cause_code` (`cause_code`)

---

### 2.2 `defect_types` — 불량 유형 코드
| Column | Type | Description |
|---|---|---|
| code | VARCHAR(20) PK | 코드 (예: D01) |
| name | VARCHAR(100) | 내용 |
| description | VARCHAR(255) NULL | 설명 |

**Seed Values**

| code | name    | description          |
| ---- | ------- | -------------------- |
| D01  | 외관-파손   | 칩핑, 깨짐, 파손, 등 구조적 손상 |
| D02  | 외관-소재기인 | 크랙, 핀홀 등 표면 균열 및 구멍  |
| D03  | 외관-오염   | 이물, 얼룩, 변색, 기름       |
| D04  | 외관-표면결함 | 툴마크, 흑피, 스크래치, 형상상이  |
| D05  | 치수불량    | 가공 치수 및 공차 이탈        |
| D06  | 조립불량    | 체결 불량                |
| D07  | 기타      | 위 항목에 해당하지 않는 경우     |

---

### 2.3 `defect_causes` — 발생 원인 코드(6M)
| Column | Type | Description |
|---|---|---|
| code | VARCHAR(20) PK | 코드 (예: M1.1) |
| category | VARCHAR(30) | 6M Category (Material/Machine/Man/Method/Measurement/Environment/Other) |
| name | VARCHAR(100) | 내용 |
| description | VARCHAR(255) NULL | 설명 |

**Seed Values (발췌)**

| code | category        | name        | description           |
| ---- | --------------- | ----------- | --------------------- |
| M1.1 | Material(소재)    | 소재-제조처      | 원자재 자체 불량             |
| M1.2 | Material(소재)    | 소재-외주1차     | 외주 소재 준비 불량           |
| M2.1 | Machine(설비)     | 설비-고장/오작동   | 기계 고장, 오작동            |
| M2.2 | Machine(설비)     | 설비-부품고장     | 모터, 백흄펌프 등 부속부품 고장    |
| M3.1 | Man(사람)         | 사람-작업자부주의   | 순간 부주의, 실수            |
| M3.2 | Man(사람)         | 사람-숙련도부족    | 작업자 스킬부족              |
| M4.1 | Method(방법)      | 방법-공구마모/파손  | 교체주기 미준수, 파손공구사용      |
| M4.2 | Method(방법)      | 방법-공구오사용    | 부적절한 공구 선택/사용         |
| M4.3 | Method(방법)      | 방법-JIG세팅오류  | 고정구, 지그 세팅 불량         |
| M4.4 | Method(방법)      | 방법-기준점세팅오류  | 원점, 좌표 설정 오류          |
| M4.5 | Method(방법)      | 방법-공정조건설정오류 | 절삭속도, 이동속도 부적절        |
| M4.6 | Method(방법)      | 방법-작업지시전달미흡 | 지시누락, 변경사항 미전달        |
| M4.7 | Method(방법)      | 방법-설계검토미흡   | 변경 미반영, 도면 미확인        |
| M4.8 | Method(방법)      | 방법-프로그램오사용  | 잘못된 프로그램 선택/사용        |
| M5.1 | Measurement(측정) | 측정-도면오작성    | 치수, 공차 기입오류           |
| M5.2 | Measurement(측정) | 측정-도면오배포    | 잘못된 도면 배포             |
| M5.3 | Measurement(측정) | 측정-검사미흡     | 자주검사, 최종검사 미실시        |
| M5.4 | Measurement(측정) | 측정-검사구미확보   | 게이지, 치구 부족            |
| M6.1 | Enviroment(환경)  | 환경-기타환경요인   | 온도, 습도, 조도, 진동 등 환경요인 |
| M7.1 | 기타              | 기타          | 분류 불가능하거나 복합원인        |

> 운영 시에는 테이블 전체를 시드하여 사용하세요.

---

## 3) UX / UI

### 3.1 등록 탭 (Create)
- **필수 입력:** `type`, `occurrence_date`, `ncr_no`, `vendor`, `product_name`, `defect_qty`, `unit_price`(또는 0 허용), `weight_factor`, `defect_type_code`, `cause_code`
- **선택 입력:** `control_no`, `detection_stage`, `why1..why5`, `root_cause`, `operators`, `process_name`, `note`
- `total_amount`는 읽기 전용(자동 계산)
- **사내/수입 구분 UI:** `type` 라디오/셀렉트
  - `type='incoming'` 선택 시 `detection_stage` 기본값을 `incoming`으로 프리셋(옵션)

### 3.2 목록/검색 탭 (Read/Manage)
- 필터: 기간, **type(inhouse/incoming)**, vendor, product_name, defect_type_code, cause_code
- 리스트 컬럼(요약): 발생일, NCR, **type**, 업체, 품명, 수량, 합계, 불량유형, 원인코드, 발견공정
- 행 클릭 → 상세 모달(전체 필드, 5Why, root_cause)

### 3.3 수정/삭제 (Update/Delete)
- 수정: 권한 충족 시 필드 편집 → 저장
- 삭제: **물리 삭제(physical)** 수행
- 각 작업 시 감사 로그 기록

---

## 4) API 설계

### 4.1 엔드포인트
- `POST /api/nonconformance` — 생성
- `GET /api/nonconformance` — 검색/조회 (쿼리: `type`, `from`, `to`, `vendor`, `defect_type_code`, `cause_code`, `q`)
- `GET /api/nonconformance/{id}` — 상세
- `PUT /api/nonconformance/{id}` — 수정
- `DELETE /api/nonconformance/{id}` — **물리 삭제**

### 4.2 요청/응답 예시

**생성(사내)**
```json
POST /api/nonconformance
{
  "type": "inhouse",
  "occurrence_date": "2025-09-07",
  "ncr_no": "NCR-2025-001",
  "vendor": "ABC정밀",
  "product_name": "하우징-123",
  "defect_qty": 20,
  "unit_price": 3000,
  "weight_factor": 1.0,
  "defect_type_code": "D01",
  "cause_code": "M3.1",
  "control_no": "QMS-2025-000124",
  "detection_stage": "process",
  "note": "가공 중 파손"
}
```

**생성(수입)**
```json
POST /api/nonconformance
{
  "type": "incoming",
  "occurrence_date": "2025-09-08",
  "ncr_no": "NCR-2025-015",
  "vendor": "XYZ가공",
  "product_name": "브래킷-9",
  "defect_qty": 12,
  "unit_price": 2500,
  "weight_factor": 0.8,
  "defect_type_code": "D05",
  "cause_code": "M5.2",
  "detection_stage": "incoming",
  "note": "도면 오배포로 치수 기준 혼선"
}
```

**응답(성공)**
```json
{ "ok": true, "data": { "id": 101, "ncr_uid": "01JCM..." } }
```

**조회(유형별)**
```http
GET /api/nonconformance?type=incoming&from=2025-09-01&to=2025-09-30
```

---

## 5) 검증 및 오류

### 5.1 서버 검증
- `type ∈ {'inhouse','incoming'}`
- `defect_qty ≥ 1`, `unit_price ≥ 0`, `0 ≤ weight_factor ≤ 1`
- `defect_type_code`와 `cause_code`는 각각 코드 테이블 참조 무결성 검사
- `total_amount` 재계산 후 저장

### 5.2 오류 코드
- 400 `validation_error` (필수 누락/코드 미존재/범위 오류)
- 401 `unauthorized` (JWT 누락/만료)
- 403 `forbidden` (권한 부족)
- 404 `not_found` (id/NCR 검색 결과 없음)
- 409 `conflict` (동시 수정/상태 충돌)
- 500 `server_error`

---

## 6) 6M 활용 팁 & 대분류 구분 기준 (모달/툴팁 제공)

### 6.1 활용 팁
1) 점검 순서 추천: **Material → Machine → Method → Man → Measurement → Environment**  
2) **Man vs Method**  
   - Man: 개인의 주의/숙련도 문제(개인차/1회성)  
   - Method: 절차·관리 체계 설계 문제(반복성/구조적)  
3) **Method vs Measurement**  
   - Method: 작업 방식/조건/순서의 오류  
   - Measurement: 검사·측정·기준 데이터(도면/사양) 오류

### 6.2 대분류 구분 기준(요약)
- **Man**: 개인의 주의력/숙련도 문제(부주의, 숙련도 부족, 피로 등)
- **Method**: 절차/작업방식/변경관리/조건 설정 오류
- **Machine**: 설비 고장/정밀도/부품 마모 등 하드웨어 결함
- **Material**: 원자재/외주품 품질 문제/LOT 편차/보관취급 불량
- **Measurement**: 도면 오류/오배포/검사 미흡/검사구·계측기 문제
- **Environment**: 온도·습도·조도·진동·정전기 등 환경 요인

> UI 제안: 등록 폼 상단에 “6M 가이드” 아이콘(❓) 배치 → 클릭 시 모달로 **6.1~6.2** 표시. 입력 필드 우측에는 관련 **툴팁** 제공.

---

## 7) 목록/통계 활용 예시
- **유형별 집계:** `type` 별 건수, `SUM(total_amount)`  
- **원인별 집계:** 6M Category/`cause_code` 그룹핑  
- **유형×원인 교차표:** inhouse vs incoming 비교  
- **월별 트렌드:** `occurrence_date` 월 단위 카운트/금액

---

## 8) 마이그레이션 & 시드
- 신규 컬럼 적용: `type`, `weekday_code`(선택), 금액 컬럼 DECIMAL로 교체 권장
- 시드: `defect_types`, `defect_causes` 전체 코드 적재
- 과거 데이터 이관: `type` 미지정 이력은 규칙에 따라 분류(inhouse 기본, 수입검사 발견 시 incoming 등)

---

## 9) 테스트 체크리스트
- `type` 필수 검증 및 목록 필터 동작
- `total_amount` 자동계산 정확성(경계값: 0, 소수점 반올림)
- 코드 테이블(유형/원인) 선택값 일치 및 무결성
- 5Why 저장/조회, root_cause 반영
- 물리 삭제 후 재조회 미노출, 감사 로그 기록
- 6M 가이드 모달/툴팁 표시 및 접근성 검토

---

## 10) 부록 — 필드 대응표(한글 → 영문)
| 한글 필드 | 영문 컬럼 |
|---|---|
| 발생일 | occurrence_date |
| NCR NO | ncr_no |
| 업체명 | vendor |
| 품명 | product_name |
| 관리번호 | control_no |
| 부적합수량 | defect_qty |
| 금액 | unit_price |
| 가중치 | weight_factor |
| 합계 | total_amount |
| 발견공정 | detection_stage |
| 불량유형 | defect_type_code |
| 발생원인 | cause_code |
| 1Why~5Why | why1~why5 |
| 최종불량원인 | root_cause |
| 작업자 | operators |
| 공정 | process_name |
| 요일 | weekday_code (MON..SUN) |
| 비고 | note |

**끝.**

